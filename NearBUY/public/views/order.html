<!DOCTYPE html>
<html>

<!-- sets up angular -->
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
<!-- <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBsTAjge0lRGrWRkJvgDbH7s6-OFy7hnRo&libraries=places"></script> -->
  <head>
    <title>Order Form</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="assets/css/main.css" />
  </head>

  <body class="subpage">
    <div ng-app="OrderCtrl" ng-controller="OrderController">
  <!-- Header -->
    <header id="header">
      <div class="inner">
        <a href="../index.html" class="logo"><img src="images/logo.png" width="120" height="50"/></a>
        <nav id="nav">
          <a href="../index.html">Home</a>
          <a href="home.html">Roles</a>
          <a href="tracking.html">Track</a>
          <a href="manage.html">Manage Deliveries</a>
        </nav>
        <a href="#navPanel" class="navPanelToggle"><span class="fa fa-bars"></span></a>
      </div>
    </header>

    <!-- Three -->
    <section id="three" class="wrapper">
      <div class="inner">
        <header class="align-center">
          <h2>Order From </h2><h2 id="here"></h2>
        </header>
      </div>

      <h3> Shopping list </h3>
      Please enter in a shopping list below:</br>

    <div>
      <input type="text" ng-model="newItem" placeholder="Enter in an item" required />
      <p><button ng-click="addItem()" class="btn btn-primary">Add</button></p>
    </div>

    Please enter the amount you are willing to pay:</br>
    <div>
      <input type="text" id="price" placeholder="Amount (to the nearest dollar)" ng-model="price" required>
      <button type="button" ng-click="updateTotal()">Update</button>
    </div>

    <div class="table-wrapper">
      <table class="alt">
        <thead>
          <tr>
            <th>Item</th>
            <th>Price</th>
          </tr>
        </thead>

        <tbody>
            <tr ng-repeat="item in list">
              <td>{{ item.name }}</td>
              <td><button type="button" class="button alt small" ng-click="deleteItem($index)">Remove</a></td>
            </tr>
        </tbody>

        <tfoot>
          <tr>
            <td colspan="1"></td>
            <td>Total Cost: ${{ total }}</td>
          </tr>
        </tfoot>
      </table>
    </div>

    Enter in any additional comments on your products below:</br>
    <textarea name="myTextBox" cols="50" rows="5" ng-model="notes">
      Enter additional info...
    </textarea>

  </section>

  <h3>Payment and Delivery</h3>
  Please enter payment and delivery details below:</br>

  <!-- this for the square payment form -->
  <script type="text/javascript" src="https://js.squareup.com/v2/paymentform"></script>

  <!--
    These styles can live in a separate .css file. They're just here to keep this
    example to a single file.
  -->
  <style type="text/css">
    .sq-input {
      border: 1px solid rgb(223, 223, 223);
      outline-offset: -2px;
      margin-bottom: 5px;
    }
    .sq-input--focus {
      /* Indicates how form inputs should appear when they have focus */
      outline: 5px auto rgb(59, 153, 252);
    }
    .sq-input--error {
      /* Indicates how form inputs should appear when they contain invalid values */
      outline: 5px auto rgb(255, 97, 97);
    }
  </style>

<form id="payment-form" onsubmit="return paymentFormSubmit()"> 

  <input type="text" id="email" name="email"  ng-model="email" placeholder="Email" required/>
  <input type="text" id="name" name="name" ng-model="name" placeholder="Name" required/>
  <input type="text" id="number" name="number" ng-model="number" placeholder="Phone Number" required/>


  <h4>Delivery Address</h4>

  <label>Street</label>
  <input type="text" id="street_address_1" name="street_address_1" ng-model="address_1" placeholder="Address Line 1"required/>

  <label>Street</label>
  <input type="text" id="street_address_2" name="street_address_2" ng-model="address_2" placeholder="Address Line 2"/>

  <label>City</label>
  <input type="text" id="city" name="city"  ng-model="city" placeholder="City" required/>

  <label>State</label>
  <select id="state" name="state" ng-model="state" required>
  <option value="AL">Alabama</option>
  <option value="AK">Alaska</option>
  <option value="AZ">Arizona</option>
  <option value="AR">Arkansas</option>
  <option value="CA">California</option>
  <option value="CO">Colorado</option>
  <option value="CT">Connecticut</option>
  <option value="DE">Delaware</option>
  <option value="DC">District of Columbia</option>
  <option value="FL">Florida</option>
  <option value="GA">Georgia</option>
  <option value="HI">Hawaii</option>
  <option value="ID">Idaho</option>
  <option value="IL">Illinois</option>
  <option value="IN">Indiana</option>
  <option value="IA">Iowa</option>
  <option value="KS">Kansas</option>
  <option value="KY">Kentucky</option>
  <option value="LA">Louisiana</option>
  <option value="ME">Maine</option>
  <option value="MD">Maryland</option>
  <option value="MA">Massachusetts</option>
  <option value="MI">Michigan</option>
  <option value="MN">Minnesota</option>
  <option value="MS">Mississippi</option>
  <option value="MO">Missouri</option>
  <option value="MT">Montana</option>
  <option value="NE">Nebraska</option>
  <option value="NV">Nevada</option>
  <option value="NH">New Hampshire</option>
  <option value="NJ">New Jersey</option>
  <option value="NM">New Mexico</option>
  <option value="NY">New York</option>
  <option value="NC">North Carolina</option>
  <option value="ND">North Dakota</option>
  <option value="OH">Ohio</option>
  <option value="OK">Oklahoma</option>
  <option value="OR">Oregon</option>
  <option value="PA">Pennsylvania</option>
  <option value="RI">Rhode Island</option>
  <option value="SC">South Carolina</option>
  <option value="SD">South Dakota</option>
  <option value="TN">Tennessee</option>
  <option value="TX">Texas</option>
  <option value="UT">Utah</option>
  <option value="VT">Vermont</option>
  <option value="VA">Virginia</option>
  <option value="WA">Washington</option>
  <option value="WV">West Virginia</option>
  <option value="WI">Wisconsin</option>
  <option value="WY">Wyoming</option>
  </select>

  <label>Zip</label>
  <input type="text" id="zip" name="zip" ng-model="zip" placeholder="Zip"/>

  <div id="card-errors">

  </div>

  <h4>Card Information</h3>
  <!--
    These div elements are the placeholder elements that are replaced by the
    SqPaymentForm's iframes.
  -->
  <div>
  <label>Card Number</label>
  <div id="sq-card-number"></div>
  </div>

  <div>
  <label>CVV</label>
  <div id="sq-cvv"></div>
  </div>

  <div>
  <label>Expiration Date</label>
  <div id="sq-expiration-date"></div>
  </div>

  <div>
  <label>Postal Code</label>
  <div id="sq-postal-code"></div>
  </div>

  <div>
  <input type="submit" id="submit" value="Buy Now" class="btn btn-primary" ng-click="addRequest()" onClick="window.location='tracking.html'">
  </div>

  </form>
  </div>
 <script>

    var applicationId = 'sandbox-sq0idp-0ibNUDIACVVf8P4I1orp9g'; // <-- Add your application's ID here
    var cardNonce;
    var paymentForm = new SqPaymentForm({
      applicationId: applicationId,
      inputClass: 'sq-input',
      inputStyles: [
          {
            fontSize: '14px',
            padding: '7px 12px',
            backgroundColor: "transparent"
          }
        ],
      cardNumber: {
        elementId: 'sq-card-number',
        placeholder: '0000 0000 0000 0000'    
      },
      cvv: {
        elementId: 'sq-cvv',
        placeholder: 'CVV'
      },
      expirationDate: {
        elementId: 'sq-expiration-date',
        placeholder: 'MM/YY'
      },
      postalCode: {
        elementId: 'sq-postal-code',
        placeholder: '94110'
      },
      callbacks: {
        cardNonceResponseReceived: function(errors, nonce, cardData) {
          if (errors){
            var error_html = ""
            for (var i =0; i < errors.length; i++){
              error_html += "<li> " + errors[i].message + " </li>";
            }
            document.getElementById("card-errors").innerHTML = error_html;
            document.getElementById('submit').disabled = false;
          }else{
            document.getElementById("card-errors").innerHTML = "";
            chargeCardWithNonce(nonce);
          }
          
          
        },
        unsupportedBrowserDetected: function() {
          // Alert the buyer
        }
      }
    });

    // build payment form after DOM load
    document.addEventListener('page:change', function(){
      console.log('dom loaded')
      paymentForm.build()
    });

    var paymentFormSubmit = function(){
      console.log('submit clicked');
      document.getElementById('submit').disabled = true;
      paymentForm.requestCardNonce();
      return false;
    }

    var chargeCardWithNonce = function(nonce) {
      // var name = document.getElementById('name').value;
      var email = document.getElementById('email').value;
      // var street_address_1 = document.getElementById('street_address_1').value;
      // var street_address_2 = document.getElementById('street_address_2').value;
      // var city = document.getElementById('city').value;
      // var state = document.getElementById('state').value;
      // var zip = document.getElementById('zip').value;
      var price = document.getElementById('price').value;
      
      var http = new XMLHttpRequest();
      var url = "/api/payment";
      var params = "transaction_id=" + 11111 //change this to an encyrption of a user id
      +"&user_email=" + email 
      + "&nonce=" + nonce
      + "&price=" + price;

      http.open("POST", url, true);

      //Send the proper header information along with the request
      http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      http.setRequestHeader("X-CSRF-Token", "<%= form_authenticity_token %>");

      http.onreadystatechange = function() {//Call a function when the state changes.
          if(http.readyState == 4 && http.status == 200) {
            var data = JSON.parse(http.responseText)
            if (data.status == 200) {
              // document.getElementById("successNotification").style.display = "block";
              // document.getElementById("payment-form").style.display = "none";
              // window.scrollTo(0, 0);
              console.log('success');
              console.log(data);
            }else if (data.status == 400){
              var error_html = ""
              for (var i =0; i < data.errors.length; i++){
                error_html += "<li> " + data.errors[i].detail + " </li>";
              }
              // document.getElementById("card-errors").innerHTML = error_html;
              // document.getElementById('submit').disabled = false;
              console.log('failure');
            }
          }
      }
      http.send(params);
    }

</script>

    <!-- Footer -->
    <footer id="footer">
      <div class="inner">
        <div class="copyright">
          Copyright (c) 2016 NearBUY
        </div>

      </div>
    </footer>

    <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/skel.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>
    <!-- ANGULAR CUSTOM -->   
    <script type="text/javascript" src="../js/appRoutes.js"></script>    
    <script type="text/javascript" src="../js/app.js"></script>
    <script type="text/javascript" src="../js/controllers/OrderCtrl.js"></script>

    </div>

  </body>
</html>
